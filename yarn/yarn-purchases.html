<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>مشتريات الخيط</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="./yarn-purchases.css" />
</head>

<body>
  <div class="page">

    <header class="topbar">
      <div>
        <h1>مشتريات الخيط</h1>
        <p class="muted">إدخال مشتريات الخيط (Item-level) وربطها بالمورد ومصنع الخام + إرسال للمراجعة.</p>
      </div>

      <div class="topbar-actions">
        <a class="btn" href="../app/index.html">العودة للرئيسية</a>
        <a class="btn" href="./yarn-purchases-table.html">جدول المشتريات</a>
        <button class="btn" id="btnNew">أذن جديد</button>
        <button class="btn" id="btnImport">استيراد شغل قديم</button>
        <button class="btn primary" id="btnSubmit">إرسال للمراجعة</button>
      </div>
    </header>

    <div class="status" id="statusBox" style="display:none"></div>

    <!-- بيانات رأس الأذن -->
    <section class="card">
      <div class="grid3">
        <div class="field">
          <label>مورد الغزل</label>
          <div class="combo">
            <select id="supplierId"></select>
            <button class="iconbtn" id="addSupplierBtn" title="إضافة مورد">+</button>
          </div>
        </div>

        <div class="field">
          <label>رقم رسالة المورد</label>
          <input id="supplierNoteNo" type="text" inputmode="numeric" placeholder="مثال: 12345" />
          <div class="hint">يتم تلقائيًا تحويل الأرقام الهندية/الفارسية إلى 0-9.</div>
        </div>

        <div class="field">
          <label>تاريخ رسالة المورد</label>
          <input id="supplierNoteDate" type="date" />
        </div>
      </div>

      <div class="grid1">
        <div class="field">
          <label>مُرسل لـ مصنع خام</label>
          <div class="combo">
            <select id="factoryId"></select>
            <button class="iconbtn" id="addFactoryBtn" title="إضافة مصنع خام">+</button>
          </div>
          <div class="hint">إلزامي دائمًا.</div>
        </div>
      </div>
    </section>

    <!-- بنود الأذن -->
    <section class="card">
      <div class="section-head">
        <h2>بنود الأذن (Item-level)</h2>
        <div class="section-actions">
          <button class="btn" id="btnAddItem">إضافة بند</button>
        </div>
      </div>

      <div class="items-wrap" id="itemsWrap"></div>

      <div class="totals">
        <div class="totals-row">
          <span class="muted">الإجمالي</span>
          <strong id="grandTotal">0</strong>
        </div>
      </div>
    </section>

    <!-- صورة الأذن -->
    <section class="card">
      <div class="section-head">
        <h2>صورة الأذن (اختياري)</h2>
        <div class="section-actions">
          <button class="btn" id="btnPickImage">اختيار صورة</button>
          <button class="btn danger" id="btnRemoveImage">حذف الصورة</button>
        </div>
      </div>

      <input id="fileInput" type="file" accept="image/*" hidden />

      <div class="image-box">
        <img id="receiptImage" alt="معاينة صورة الأذن" />
        <div class="image-placeholder muted" id="imagePlaceholder">
          لا توجد صورة. عند الرفع سيتم تصغيرها تلقائيًا إلى 1200px.
        </div>
      </div>
    </section>

  </div>

  <!-- Template: بند -->
  <template id="itemTpl">
    <div class="item">
      <div class="item-head">
        <div class="item-title">بند</div>
        <button class="btn danger small btnRemoveItem">حذف البند</button>
      </div>

      <div class="grid3">
        <div class="field">
          <label>نوع الغزل</label>
          <div class="combo">
            <select class="yarnTypeId"></select>
            <button class="iconbtn addYarnTypeBtn" title="إضافة نوع">+</button>
          </div>
        </div>

        <div class="field">
          <label>ماركة الغزل</label>
          <div class="combo">
            <select class="yarnBrandId" disabled></select>
            <button class="iconbtn addYarnBrandBtn" title="إضافة ماركة">+</button>
          </div>
          <div class="hint">الماركات تتفلتر حسب نوع الغزل.</div>
        </div>

        <div class="field">
          <label>رقم اللوط (اختياري)</label>
          <input class="lotNo" type="text" inputmode="numeric" placeholder="مثال: 7788" />
        </div>
      </div>

      <div class="grid3">
        <div class="field">
          <label>الكمية</label>
          <input class="qty" type="text" inputmode="decimal" placeholder="مثال: 500" />
        </div>

        <div class="field">
          <label>السعر (اختياري)</label>
          <input class="price" type="text" inputmode="decimal" placeholder="مثال: 125.5" />
        </div>

        <div class="field">
          <label>الإجمالي</label>
          <input class="lineTotal" type="text" readonly />
        </div>
      </div>
    </div>
  </template>

  <!-- Modals: Supplier -->
  <div class="modal" id="modalSupplier" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-label="إضافة مورد">
      <div class="modal-head">
        <h3>إضافة مورد جديد</h3>
        <button class="iconbtn" data-close>×</button>
      </div>
      <div class="modal-body">
        <div class="field">
          <label>اسم المورد</label>
          <input id="newSupplierName" type="text" placeholder="مثال: شركة الغزل المتحدة" />
        </div>
      </div>
      <div class="modal-foot">
        <button class="btn" data-close>إلغاء</button>
        <button class="btn primary" id="saveSupplier">حفظ</button>
      </div>
    </div>
  </div>

  <!-- Modals: Factory -->
  <div class="modal" id="modalFactory" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-label="إضافة مصنع خام">
      <div class="modal-head">
        <h3>إضافة مصنع خام جديد</h3>
        <button class="iconbtn" data-close>×</button>
      </div>
      <div class="modal-body">
        <div class="field">
          <label>اسم المصنع</label>
          <input id="newFactoryName" type="text" placeholder="مثال: مصنع خام الدائري 1" />
        </div>
      </div>
      <div class="modal-foot">
        <button class="btn" data-close>إلغاء</button>
        <button class="btn primary" id="saveFactory">حفظ</button>
      </div>
    </div>
  </div>

  <!-- Modals: Yarn Type -->
  <div class="modal" id="modalYarnType" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-label="إضافة نوع غزل">
      <div class="modal-head">
        <h3>إضافة نوع غزل جديد</h3>
        <button class="iconbtn" data-close>×</button>
      </div>
      <div class="modal-body">
        <div class="field">
          <label>اسم نوع الغزل</label>
          <input id="newYarnTypeName" type="text" placeholder="مثال: بوليستر 30/1" />
        </div>
      </div>
      <div class="modal-foot">
        <button class="btn" data-close>إلغاء</button>
        <button class="btn primary" id="saveYarnType">حفظ</button>
      </div>
    </div>
  </div>

  <!-- Modals: Yarn Brand -->
  <div class="modal" id="modalYarnBrand" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-label="إضافة ماركة">
      <div class="modal-head">
        <h3>إضافة ماركة جديدة</h3>
        <button class="iconbtn" data-close>×</button>
      </div>
      <div class="modal-body">
        <div class="field">
          <label>نوع الغزل</label>
          <select id="brandTypeId"></select>
        </div>
        <div class="field">
          <label>اسم الماركة</label>
          <input id="newYarnBrandName" type="text" placeholder="مثال: YKK / ABC Spinning" />
        </div>
      </div>
      <div class="modal-foot">
        <button class="btn" data-close>إلغاء</button>
        <button class="btn primary" id="saveYarnBrand">حفظ</button>
      </div>
    </div>
  </div>

  <!-- Modal: Import -->
  <div class="modal" id="modalImport" aria-hidden="true">
    <div class="modal-card wide" role="dialog" aria-modal="true" aria-label="استيراد بيانات قديمة">
      <div class="modal-head">
        <h3>استيراد بيانات قديمة (Copy/Paste من Excel)</h3>
        <button class="iconbtn" data-close>×</button>
      </div>

      <div class="modal-body">
        <p class="muted" style="margin-top:0">
          ألصق هنا CSV/TSV. إما مع Header row أو بدون. إذا بدون Header فالنظام يفترض هذا الترتيب:
          supplier_name, factory_name, supplier_note_no, supplier_note_date, yarn_type, yarn_brand, lot_no, qty, price
        </p>

        <textarea id="importText" class="import-area" placeholder="supplier_name	factory_name	supplier_note_no	supplier_note_date	yarn_type	yarn_brand	lot_no	qty	price"></textarea>

        <div class="field" style="margin-top:10px">
          <label>ملاحظات</label>
          <div class="hint">
            سيتم إنشاء المورد/المصنع/النوع/الماركة تلقائيًا إذا لم تكن موجودة. سيتم إرسال كل أذن “قيد المراجعة”.
          </div>
        </div>

        <div id="importProgress" class="muted" style="margin-top:10px"></div>
      </div>

      <div class="modal-foot">
        <button class="btn" data-close>إغلاق</button>
        <button class="btn primary" id="btnRunImport">تنفيذ الاستيراد</button>
      </div>
    </div>
  </div>

  <script type="module" src="./yarn-purchases.js"></script>
</body>
</html>
